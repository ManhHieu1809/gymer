<!DOCTYPE html>
<html lang="zxx">

<head>
    <meta charset="UTF-8">
    <meta name="description" content="Gym Template">
    <meta name="keywords" content="Gym, unica, creative, html">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Gym | Template</title>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css?family=Muli:300,400,500,600,700,800,900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Oswald:300,400,500,600,700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<!-- Css Styles -->
<link th:href="@{/css2/bootstrap.min.css}" rel="stylesheet" type="text/css">
<link th:href="@{/css2/font-awesome.min.css}" rel="stylesheet" type="text/css">
<link th:href="@{/css2/flaticon.css}" rel="stylesheet" type="text/css">
<link th:href="@{/css2/owl.carousel.min.css}" rel="stylesheet" type="text/css">
<link th:href="@{/css2/barfiller.css}" rel="stylesheet" type="text/css">
<link th:href="@{/css2/magnific-popup.css}" rel="stylesheet" type="text/css">
<link th:href="@{/css2/slicknav.min.css}" rel="stylesheet" type="text/css">
<link th:href="@{/css2/style.css}" rel="stylesheet" type="text/css">

    <style>
        /* Căn chỉnh phần User icon và Login/Signup trong header */

        /* Căn chỉnh biểu tượng người dùng */
        .user-icon {
            font-size: 2rem;
            color: white; /* Màu trắng cho icon */
            text-decoration: none;
            margin-right: 10px; /* Khoảng cách giữa icon và login/signup */
        }

        .user-icon:hover {
            color: #007bff; /* Màu khi hover */
        }

        /* Căn chỉnh các liên kết login/signup */
        .auth-links a {
            text-decoration: none;
            color: white; /* Màu trắng */
            font-weight: bold;
            margin-left: 0px;
        }

        .auth-links a:hover {
            color: #007bff; /* Màu khi hover */
        }

        /* Thêm hiệu ứng cho các liên kết */
        .login-btn, .signup-btn {
            text-transform: uppercase; /* Viết hoa cho các liên kết */
        }
    </style>

    <style>
        body {
            background-color: #f4f6f9;
        }
        .container {
            margin-top: 20px;
        }
        .conversation-list {
            border-right: 1px solid #ddd;
            height: 500px;
            overflow-y: auto;
            background-color: #fff;
            padding: 0; /* Xóa padding mặc định */
        }
        .conversation-item {
            padding: 8px; /* Giảm padding */
            font-size: 12px; /* Giảm cỡ chữ */
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }
        .conversation-item:hover {
            background-color: #f0f8ff;
        }
        .conversation-item.active {
            background-color: #d9edf7;
        }
        .chat-box {
            border: 1px solid #ddd;
            border-radius: 5px;
            height: 400px;
            overflow-y: scroll;
            background-color: #f9f9f9;
            padding: 10px;
        }
        .message {
            margin-bottom: 10px;
        }
        .message-left {
            text-align: left;
        }
        .message-right {
            text-align: right;
        }
        .message-content {
            display: inline-block;
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 80%;
        }
        .message-left .message-content {
            background-color: #d2d6de;
            color: #444;
        }
        .message-right .message-content {
            background-color: #007bff;
            color: #fff;
        }
        .chat-footer {
            display: flex;
            margin-top: 10px;
        }
    </style>

    <style>
        .chat-box {
            border-radius: 10px;
        }

        #messageInput::placeholder {
            font-style: italic;
            color: #adb5bd;
        }

        .btn:hover {
            box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.1);
        }

        #emojiPicker {
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 5px;
            z-index: 1000;
        }

        #emojiPicker.d-none {
            display: none;
        }
    </style>
</head>

<body>
    <!-- Page Preloder -->
    <div id="preloder">
        <div class="loader"></div>
    </div>

    <!-- Offcanvas Menu Section Begin -->
    <div class="offcanvas-menu-overlay"></div>
    <div class="offcanvas-menu-wrapper">
        <div class="canvas-close">
            <i class="fa fa-close"></i>
        </div>
        <div class="canvas-search search-switch">
            <i class="fa fa-search"></i>
        </div>
        <nav class="canvas-menu mobile-menu">
            <ul>
                <li><a href="/customer/home">Home</a></li>
                <li><a href="/customer/home/nutrition-plan">Kế hoạch dinh dưỡng</a></li>
                <li><a href="/customer/home/workout-plan">Kế hoạch luyện tập</a></li>
                <li><a href="/customer/home/Progress">Tiến độ luyện tập</a></li>
                <li><a href="/customer/home/shop">Shop</a></li>
                <li><a href="/customer/home/users/notification">Thông báo</a></li>
                <li><a href="/customer/home/chat">Chăm sóc khách hàng</a></li>
            </ul>
        </nav>
        <div id="mobile-menu-wrap"></div>

    </div>
    <!-- Offcanvas Menu Section End -->

    <!-- Header Section Begin -->
    <header class="header-section">
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-3">
                    <div class="logo">
                        <a href="/customer/home">
                            <img th:src="@{/img/logo.png}" alt="">
                        </a>
                    </div>
                </div>
                <div class="col-lg-6">
                    <nav class="nav-menu">
                        <ul>
                            <li><a href="/customer/home">Home</a></li>
                            <li><a href="/customer/home/nutrition-plan">Kế hoạch dinh dưỡng</a></li>
                            <li><a href="/customer/home/workout-plan">Kế hoạch luyện tập</a></li>
                            <li><a href="/customer/home/Progress">Tiến độ luyện tập</a></li>
                            <li><a href="/customer/home/shop">Shop</a></li>
                            <li><a href="/customer/home/users/notification">Thông báo</a></li>
                            <li class="active"><a href="/customer/home/chat">Chăm sóc khách hàng</a></li>
                        </ul>
                    </nav>
                </div>
                <div class="col-lg-3">
                    <!-- User Icon and Login/Signup Links -->
                    <div class="d-flex justify-content-end align-items-center">
                        <a href="/customer/home/users" class="user-icon" id="user-icon">
                            <i class="fa fa-user"></i>
                        </a>
                        <div class="auth-links ml-3" id="auth-links">
                            <a href="/req/login" class="login-btn" id="login-btn">Login</a> |
                            <a href="/req/signup" class="signup-btn">Signup</a>
                        </div>
                        <div class="user-info text-white" id="user-info" style="display: none;">
                            <span>Welcome, <span id="username"></span>!</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="canvas-open">
                <i class="fa fa-bars"></i>
            </div>
        </div>
    </header>
    <!-- Header End -->

    <!-- Breadcrumb Section Begin -->
    <section class="breadcrumb-section set-bg" th:data-setbg="@{/img/breadcrumb-bg.jpg}">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <div class="breadcrumb-text">
                        <h2>Chăm sóc khách hàng</h2>
                        <div class="bt-option">
                            <a href="/customer/home">Home</a>
                            <span>Chăm sóc khách hàng</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Breadcrumb Section End -->

    <!-- Contact Section Begin -->
    <section class="contact-section spad">
        <div class="container">
            <div class="row">
                <div class="col-lg-6">
                    <div class="section-title contact-title">
                        <span>Liên hệ với chúng tôi</span>

                    </div>
                    <div class="contact-widget">
                        <div class="cw-text">
                            <i class="fa fa-map-marker"></i>
                            <p>Học Viện Kĩ Thuật Mật Mã<br/> 141 Chiến Thắng, Tân Triều, Thanh Trì, Hà Nội</p>
                        </div>
                        <div class="cw-text">
                            <i class="fa fa-mobile"></i>
                            <ul>
                                <li>0364506439</li>
                                <li>0364506439</li>
                            </ul>
                        </div>
                        <div class="cw-text email">
                            <i class="fa fa-envelope"></i>
                            <p>Support.gymcenter@gmail.com</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="leave-comment">
                        <div class="col-sm-12">
                            <div class="card shadow-sm">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0"><i class="fas fa-comments"></i> Direct Chat</h5>
                                </div>
                                <div id="messages" class="chat-box p-3" style="height: 400px; overflow-y: auto; background-color: #f8f9fa; border-bottom: 1px solid #ddd;">
                                    <!-- Messages will load here -->
                                </div>
                                <div class="panel-footer" style="background-color: #f1f3f5; border-top: 1px solid #ddd; padding: 10px;">
                                    <div class="input-group align-items-center" style="display: flex; gap: 10px;">
                                        <!-- Input tin nhắn -->
                                        <input type="text" id="messageInput" class="form-control" placeholder="Type your message..." onkeypress="checkEnter(event)"
                                               style="border-radius: 20px; flex-grow: 1; padding: 10px;">

                                        <!-- Nút chọn file -->
                                        <label for="imageInput" class="btn btn-outline-secondary" style="border-radius: 50%; padding: 8px 12px; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-paperclip"></i>
                                        </label>
                                        <input type="file" id="imageInput" accept="image/*" style="display: none;">

                                        <!-- Bộ chọn Emoji -->
                                        <div id="emojiPickerWrapper" style="position: relative;">
                                            <button class="btn btn-outline-secondary" style="border-radius: 50%; padding: 8px 12px;display: flex; align-items: center; justify-content: center;"
                                                    title="Open emoji picker" onclick="toggleEmojiPicker()">
                                                <i class="fas fa-smile"></i>
                                            </button>
                                            <div id="emojiPicker" class="d-none" style="position: absolute; bottom: 100%; right: 0; background: white; box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1); padding: 10px; border-radius: 10px;">
                                                <button type="button" class="btn btn-light btn-sm" onclick="selectEmoji('😊')">😊</button>
                                                <button type="button" class="btn btn-light btn-sm" onclick="selectEmoji('😂')">😂</button>
                                                <button type="button" class="btn btn-light btn-sm" onclick="selectEmoji('❤️')">❤️</button>
                                                <button type="button" class="btn btn-light btn-sm" onclick="selectEmoji('👍')">👍</button>
                                            </div>
                                        </div>

                                        <!-- Nút gửi -->
                                        <button class="btn btn-primary" onclick="sendMessage()"
                                                style="border-radius: 20px; padding: 10px 20px; display: flex; align-items: center; justify-content: center;">
                                            Send
                                        </button>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </section>
    <!-- Contact Section End -->

    <!-- Get In Touch Section Begin -->
    <div class="gettouch-section">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <div class="gt-text">
                        <i class="fa fa-map-marker"></i>
                        <p>Học Viện Kĩ Thuật Mật Mã<br/> 141 Chiến Thắng, Tân Triều, Thanh Trì, Hà Nội</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="gt-text">
                        <i class="fa fa-mobile"></i>
                        <ul>
                            <li>125-711-811</li>
                            <li>125-668-886</li>
                        </ul>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="gt-text email">
                        <i class="fa fa-envelope"></i>
                        <p>Support.gymcenter@gmail.com</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Get In Touch Section End -->

    <!-- Footer Section Begin -->
    <section class="footer-section">
        <div class="container">
            <div class="row">
                <div class="col-lg-4">
                    <div class="fs-about">
                        <div class="fa-logo">
                            <a href="#"><img th:src="@{/img/logo.png}" alt=""></a>
                        </div>
                        <p>“Con đường dẫn đến thành công được làm nên từ những viên gạch của sự kiên trì. Hãy là chính mình, vượt qua mọi chướng ngại và theo đuổi ước mơ của bản thân.”</p>
                        <div class="fa-social">
                            <a href="#"><i class="fa fa-facebook"></i></a>
                            <a href="#"><i class="fa fa-twitter"></i></a>
                            <a href="#"><i class="fa fa-youtube-play"></i></a>
                            <a href="#"><i class="fa fa-instagram"></i></a>
                            <a href="#"><i class="fa  fa-envelope-o"></i></a>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-3 col-sm-6">
                    <div class="fs-widget">
                        <h4>Useful links</h4>
                        <ul>
                            <li><a href="#">About</a></li>
                            <li><a href="#">Blog</a></li>
                            <li><a href="#">Classes</a></li>
                            <li><a href="#">Contact</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-2 col-md-3 col-sm-6">
                    <div class="fs-widget">
                        <h4>Support</h4>
                        <ul>
                            <li><a href="#">Login</a></li>
                            <li><a href="#">My account</a></li>
                            <li><a href="#">Subscribe</a></li>
                            <li><a href="#">Contact</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6">
                    <div class="fs-widget">
                        <h4>Tips & Guides</h4>
                        <div class="fw-recent">
                            <h6><a href="#">Physical fitness may help prevent depression, anxiety</a></h6>
                            <ul>
                                <li>3 min read</li>
                                <li>20 Comment</li>
                            </ul>
                        </div>
                        <div class="fw-recent">
                            <h6><a href="#">Fitness: The best exercise to lose belly fat and tone up...</a></h6>
                            <ul>
                                <li>3 min read</li>
                                <li>20 Comment</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12 text-center">
                    <div class="copyright-text">

                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Footer Section End -->

    <!-- Search model Begin -->
    <div class="search-model">
        <div class="h-100 d-flex align-items-center justify-content-center">
            <div class="search-close-switch">+</div>
            <form class="search-model-form">
                <input type="text" id="search-input" placeholder="Search here.....">
            </form>
        </div>
    </div>
    <!-- Search model end -->

<!-- Js Plugins -->
<script th:src="@{/js2/jquery-3.3.1.min.js}"></script>
<script th:src="@{/js2/bootstrap.min.js}"></script>
<script th:src="@{/js2/jquery.magnific-popup.min.js}"></script>
<script th:src="@{/js2/masonry.pkgd.min.js}"></script>
<script th:src="@{/js2/jquery.barfiller.js}"></script>
<script th:src="@{/js2/jquery.slicknav.js}"></script>
<script th:src="@{/js2/owl.carousel.min.js}"></script>
<script th:src="@{/js2/main.js}"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // Hàm lấy và hiển thị tên người dùng
            async function fetchAndDisplayUsernames() {
                try {
                    // Gửi yêu cầu GET tới API
                    const response = await fetch('http://localhost:8080/customer/home/users/user-info1', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include' // Đảm bảo gửi cookie session
                    });

                    if (response.ok) {
                        const data = await response.json(); // Lấy dữ liệu JSON từ phản hồi
                        const username = data.username;

                        // Hiển thị tên người dùng và ẩn các liên kết login/signup
                        document.getElementById("auth-links").style.display = 'none'; // Ẩn "Login" và "Signup"
                        document.getElementById("user-info").style.display = 'block'; // Hiển thị tên người dùng
                        document.getElementById("username").innerText = username; // Cập nhật tên người dùng
                    } else {
                        console.error("Error fetching username:", response.statusText);
                    }
                } catch (error) {
                    console.error("Error fetching username:", error);
                }
            }

            // Kiểm tra khi tải trang và gọi API
            fetchAndDisplayUsernames();
        });

    </script>

    <script>
        let customerUsername = ""; // Sẽ được gán giá trị từ API
        const adminUsername = "admin"; // Username của admin
        let conversationId = ""; // Sẽ được thiết lập sau khi lấy được username

        const socket = new SockJS('/ws');
        const stompClient = Stomp.over(socket);

        // Kết nối WebSocket
        stompClient.connect({}, function (frame) {
            console.log('Connected as: ' + frame);

            if (conversationId) {
                stompClient.subscribe('/topic/messages/' + conversationId, function (message) {
                    showMessage(JSON.parse(message.body));
                });
            }
        });

        async function createConversation() {
            const conversation = {
                conversationId: conversationId,
                adminUsername: adminUsername,
                customerUsername: customerUsername
            };

            try {
                const response = await fetch('http://localhost:8080/customer/home/users/conversations/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(conversation)
                });

                if (!response.ok) {
                    console.error("Failed to create conversation:", response.statusText);
                } else {
                    console.log("Conversation created successfully");
                }
            } catch (error) {
                console.error("Error creating conversation:", error);
            }
        }


        async function fetchAndDisplayUsernames() {

            try {
                const response = await fetch('http://localhost:8080/customer/home/users/user-info1', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();

                    if (data && data.username) {
                        customerUsername = data.username;
                        conversationId = adminUsername + "-" + customerUsername;

                        await createConversation();

                        if (!isSubscribed &&conversationId) {
                            stompClient.subscribe('/topic/messages/' + conversationId, function (message) {
                                showMessage(JSON.parse(message.body));
                            });
                            isSubscribed = true;
                        }
                    } else {
                        console.error("Username not found in the response");
                    }
                } else {
                    console.error("Error fetching username:", response.statusText);
                }
            } catch (error) {
                console.error("Error fetching username:", error);
            }
        }

        window.onload = fetchAndDisplayUsernames;

        function sendMessage() {
            const messageInputElem = document.getElementById('messageInput');
            const imageInputElem = document.getElementById('imageInput');

            if (!messageInputElem || !imageInputElem) {
                console.error("Required elements are missing in the DOM.");
                return;
            }

            const messageInput = messageInputElem.value;
            const imageInput = imageInputElem.files[0];

            if (conversationId && customerUsername && adminUsername) {
                let message = {
                    senderUsername: customerUsername,
                    receiverUsername: adminUsername,
                    conversationId: conversationId,
                    message: "",
                    type: "text"
                };

                if (imageInput) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = function () {
                            // Tạo một canvas để thay đổi kích thước ảnh
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');

                            const maxWidth = 800; // Kích thước ảnh tối đa (ví dụ: 800px chiều rộng)
                            const maxHeight = 600; // Kích thước tối đa theo chiều cao
                            const scaleFactor = Math.min(maxWidth / img.width, maxHeight / img.height);

                            canvas.width = img.width * scaleFactor;
                            canvas.height = img.height * scaleFactor;

                            // Vẽ ảnh vào canvas với kích thước mới
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                            // Chuyển ảnh từ canvas thành chuỗi base64 với chất lượng giảm (ví dụ: 0.7 chất lượng)
                            const resizedImage = canvas.toDataURL('image/jpeg', 0.7);
                            message.message = resizedImage;
                            message.type = "image";
                            stompClient.send("/app/chat/" + conversationId, {}, JSON.stringify(message));
                        };
                    };
                    reader.readAsDataURL(imageInput);
                } else if (messageInput.trim()) {
                    message.message = messageInput;
                    message.type = "text";
                    stompClient.send("/app/chat/" + conversationId, {}, JSON.stringify(message));
                }

                // Reset inputs sau khi gửi
                messageInputElem.value = '';
                imageInputElem.value = '';
            } else {
                console.error("WebSocket connection is not established or missing data.");
            }
        }



        function showMessage(message) {
            const messagesBox = document.getElementById('messages');
            const messageElement = document.createElement('div');

            const alignClass = message.senderUsername === adminUsername ? 'message-left' : 'message-right';

            messageElement.className = `message ${alignClass}`;

            if (message.type === "text") {
                messageElement.innerHTML = `
            <div class="message-content">
                <strong>${message.senderUsername}</strong><br>
                ${message.message}<br>
                <small>${new Date().toLocaleTimeString()}</small>
            </div>
        `;
            } else if (message.type === "image") {
                messageElement.innerHTML = `
            <div class="message-content">
                <strong>${message.senderUsername}</strong><br>
                <img src="${message.message}" alt="Image" style="max-width: 200px;"><br>
                <small>${new Date().toLocaleTimeString()}</small>
            </div>
        `;
            } else if (message.type === "emoji") {
                messageElement.innerHTML = `
            <div class="message-content">
                <strong>${message.senderUsername}</strong><br>
                <span style="font-size: 24px;">${message.message}</span><br>
                <small>${new Date().toLocaleTimeString()}</small>
            </div>
        `;
            }

            messagesBox.appendChild(messageElement);
            messagesBox.scrollTop = messagesBox.scrollHeight;
        }

        function checkEnter(event) {
            if (event.key === "Enter") {
                sendMessage();
            }
        }

        function toggleEmojiPicker() {
            const emojiPicker = document.getElementById('emojiPicker');
            if (emojiPicker.classList.contains('d-none')) {
                emojiPicker.classList.remove('d-none'); // Hiển thị bộ chọn emoji
            } else {
                emojiPicker.classList.add('d-none'); // Ẩn bộ chọn emoji
            }
        }

        function selectEmoji(emoji) {
            const messageInput = document.getElementById('messageInput');
            messageInput.value += emoji; // Thêm emoji vào nội dung tin nhắn
        }

    </script>

</body>

</html>